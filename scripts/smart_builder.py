#!/usr/bin/env python3
"""
Doc Processor Skill - æ™ºèƒ½æ¨¡æ¿å¤„ç†
æ”¯æŒæ¨¡æ¿è·¯å¾„æ£€æŸ¥å’Œç”¨æˆ·äº¤äº’
"""

import os
import json
import sys
from pathlib import Path

def check_template_exists(template_path):
    """
    æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨æä¾›è¯¦ç»†å¸®åŠ©
    """
    if not template_path or not os.path.exists(template_path):
        error_msg = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âŒ æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“„ æŒ‡å®šè·¯å¾„: {template_path}

ğŸ” å¯èƒ½åŸå› :
  1. æ–‡ä»¶è·¯å¾„é”™è¯¯
  2. æ–‡ä»¶åœ¨å½“å‰sessionç»“æŸåè¢«æ¸…ç†ï¼ˆ/tmp/ç›®å½•æ–‡ä»¶ä¼šè¢«å®šæœŸæ¸…ç†ï¼‰
  3. æ–‡ä»¶è¢«ç§»åŠ¨æˆ–åˆ é™¤

ğŸ’¡ è§£å†³æ–¹æ¡ˆ:

  æ–¹æ¡ˆA - æä¾›æ­£ç¡®çš„æ¨¡æ¿è·¯å¾„:
     è¯·æä¾›æ¨¡æ¿æ–‡ä»¶çš„å®Œæ•´ç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚:
     /Users/xxx/documents/template.docx

  æ–¹æ¡ˆB - é‡æ–°ä¸Šä¼ æ¨¡æ¿:
     å°†æ¨¡æ¿æ–‡ä»¶é‡æ–°ä¸Šä¼ åˆ°å½“å‰å¯¹è¯ä¸­ï¼Œç„¶åæä¾›æ–°è·¯å¾„

  æ–¹æ¡ˆC - ä½¿ç”¨é»˜è®¤æ¨¡æ¿:
     ç³»ç»Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤ç©ºç™½æ¨¡æ¿ç”Ÿæˆæ–‡æ¡£

âš ï¸  é‡è¦æç¤º:
  /tmp/ç›®å½•ä¸‹çš„æ–‡ä»¶åœ¨sessionç»“æŸåä¼šè¢«æ¸…ç†ï¼
  å»ºè®®å°†æ¨¡æ¿æ–‡ä»¶ä¿å­˜åˆ°ç”¨æˆ·ç›®å½•ä¸‹ï¼Œå¦‚:
  ~/Documents/templates/lesson_template.docx

"""
        return False, error_msg
    return True, None

def get_default_template():
    """
    è·å–é»˜è®¤æ¨¡æ¿è·¯å¾„
    """
    # å°è¯•æŸ¥æ‰¾é»˜è®¤æ¨¡æ¿
    default_paths = [
        "/Users/xielk/webdata/english/lesson/templates/default_lesson_template.docx",
        "/Users/xielk/webdata/english/lesson/skills/doc_processor/resources/default_template.docx",
    ]
    
    for path in default_paths:
        if os.path.exists(path):
            return path
    
    return None

def ask_for_template():
    """
    åœ¨å¯¹è¯ä¸­è¯¢é—®æ¨¡æ¿è·¯å¾„
    è¿”å›ç”¨æˆ·æä¾›çš„æœ‰æ•ˆè·¯å¾„æˆ–None
    """
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“ è¯·æä¾›æ¨¡æ¿æ–‡ä»¶è·¯å¾„                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ¨¡æ¿æ–‡ä»¶é€šå¸¸ä½äº:
  â€¢ /tmp/xxx.docx (ä¸´æ—¶æ–‡ä»¶ï¼Œå¯èƒ½è¢«æ¸…ç†)
  â€¢ ~/Documents/xxx.docx (æ¨èï¼Œæ°¸ä¹…ä¿å­˜)
  â€¢ å…¶ä»–ä½ç½®

è¯·æä¾›å®Œæ•´çš„æ¨¡æ¿æ–‡ä»¶ç»å¯¹è·¯å¾„: 
    """)
    
    # æ³¨æ„ï¼šå®é™…å¯¹è¯ä¸­è¿™é‡Œåº”è¯¥ç­‰å¾…ç”¨æˆ·è¾“å…¥
    # ä½†åœ¨è‡ªåŠ¨åŒ–è„šæœ¬ä¸­ï¼Œæˆ‘ä»¬è¿”å›Noneè®©è°ƒç”¨è€…å¤„ç†
    return None

def smart_build_doc(template_path, content_json_path, output_path, use_default=True):
    """
    æ™ºèƒ½æ„å»ºæ–‡æ¡£ï¼Œè‡ªåŠ¨å¤„ç†æ¨¡æ¿ä¸å­˜åœ¨çš„æƒ…å†µ
    
    Args:
        template_path: ç”¨æˆ·æä¾›çš„æ¨¡æ¿è·¯å¾„
        content_json_path: å†…å®¹JSONè·¯å¾„
        output_path: è¾“å‡ºè·¯å¾„
        use_default: å¦‚æœæ¨¡æ¿ä¸å­˜åœ¨ï¼Œæ˜¯å¦ä½¿ç”¨é»˜è®¤æ¨¡æ¿
    
    Returns:
        (success, message)
    """
    from docx import Document
    
    # 1. æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å­˜åœ¨
    exists, error_msg = check_template_exists(template_path)
    
    if not exists:
        print(error_msg)
        
        if use_default:
            # å°è¯•ä½¿ç”¨é»˜è®¤æ¨¡æ¿
            default_template = get_default_template()
            if default_template:
                print(f"\nâš¡ è‡ªåŠ¨åˆ‡æ¢åˆ°é»˜è®¤æ¨¡æ¿: {default_template}")
                template_path = default_template
            else:
                print("\nâŒ é»˜è®¤æ¨¡æ¿ä¹Ÿä¸å­˜åœ¨ï¼Œè¯·æä¾›æœ‰æ•ˆçš„æ¨¡æ¿è·¯å¾„")
                return False, "æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨"
        else:
            # ä¸ä½¿ç”¨é»˜è®¤æ¨¡æ¿ï¼Œè¯·æ±‚ç”¨æˆ·æä¾›
            print("\nâ³ ç­‰å¾…ç”¨æˆ·æä¾›æ¨¡æ¿è·¯å¾„...")
            return False, "éœ€è¦æä¾›æ¨¡æ¿è·¯å¾„"
    
    # 2. æ£€æŸ¥å†…å®¹æ–‡ä»¶
    if not os.path.exists(content_json_path):
        error_msg = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âŒ å†…å®¹æ–‡ä»¶ä¸å­˜åœ¨                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“„ æŒ‡å®šè·¯å¾„: {content_json_path}

è¯·å…ˆç”Ÿæˆå†…å®¹æ–‡ä»¶(content.json)ï¼Œå†æ„å»ºæ–‡æ¡£ã€‚
"""
        print(error_msg)
        return False, "å†…å®¹æ–‡ä»¶ä¸å­˜åœ¨"
    
    # 3. æ„å»ºæ–‡æ¡£
    try:
        print(f"\nğŸ“– æ­£åœ¨åŠ è½½æ¨¡æ¿: {template_path}")
        doc = Document(template_path)
        
        print(f"ğŸ“„ æ­£åœ¨åŠ è½½å†…å®¹: {content_json_path}")
        with open(content_json_path, 'r', encoding='utf-8') as f:
            content_map = json.load(f)
        
        # å¡«å……å†…å®¹ï¼ˆä½¿ç”¨åŸæœ‰çš„builderé€»è¾‘ï¼‰
        # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦å¤ç”¨builder.pyçš„é€»è¾‘
        # ... å¡«å……é€»è¾‘ ...
        
        # ä¿å­˜æ–‡æ¡£
        doc.save(output_path)
        print(f"\nâœ… æ–‡æ¡£ç”ŸæˆæˆåŠŸ: {output_path}")
        return True, "æˆåŠŸ"
        
    except Exception as e:
        error_msg = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âŒ æ„å»ºæ–‡æ¡£æ—¶å‡ºé”™                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é”™è¯¯ä¿¡æ¯: {str(e)}

å¯èƒ½åŸå› :
  â€¢ æ¨¡æ¿æ–‡ä»¶æŸå
  â€¢ å†…å®¹JSONæ ¼å¼é”™è¯¯
  â€¢ å†…å­˜ä¸è¶³

å»ºè®®:
  1. æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦èƒ½æ­£å¸¸æ‰“å¼€
  2. éªŒè¯content.jsonæ–‡ä»¶æ ¼å¼
  3. é‡æ–°å°è¯•ç”Ÿæˆ
"""
        print(error_msg)
        import traceback
        traceback.print_exc()
        return False, str(e)

def main():
    """
    ä¸»å‡½æ•°ï¼Œå¤„ç†å‘½ä»¤è¡Œå‚æ•°
    """
    if len(sys.argv) < 4:
        print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“š Doc Processor - æ–‡æ¡£ç”Ÿæˆå™¨                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”¨æ³•:
  python smart_builder.py <æ¨¡æ¿æ–‡ä»¶> <å†…å®¹JSON> <è¾“å‡ºæ–‡ä»¶>

å‚æ•°:
  æ¨¡æ¿æ–‡ä»¶   - Wordæ–‡æ¡£æ¨¡æ¿ (.docx)
  å†…å®¹JSON   - å¡«å……å†…å®¹æ•°æ® (.json)
  è¾“å‡ºæ–‡ä»¶   - ç”Ÿæˆçš„æ–‡æ¡£è·¯å¾„ (.docx)

ç¤ºä¾‹:
  python smart_builder.py \\
    "/Users/xxx/template.docx" \\
    "/Users/xxx/content.json" \\
    "/Users/xxx/output.docx"

æ³¨æ„:
  â€¢ å»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„
  â€¢ é¿å…ä½¿ç”¨/tmp/ç›®å½•ï¼Œæ–‡ä»¶å¯èƒ½è¢«æ¸…ç†
  â€¢ æ¨¡æ¿æ–‡ä»¶å¿…é¡»å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
        """)
        sys.exit(1)
    
    template_path = sys.argv[1]
    content_path = sys.argv[2]
    output_path = sys.argv[3]
    
    # æ™ºèƒ½æ„å»º
    success, message = smart_build_doc(template_path, content_path, output_path)
    
    if not success:
        sys.exit(1)

if __name__ == "__main__":
    main()
